'use strict';/*
 lui.js web frame work 1.0.0
 inspired by react and mithril
 L3P3.de 2021
*/
{let e=null,f=!e,g=e,h=0,q=0,t=0,u=f,v=[],w=[];
const B={},C={},aa={},ba=[],D=[],E=e,F=f,G=!f,H=Array,ca=Object,da=ca.assign,I=ca.keys,ea=document,J=window,fa=J.performance||Date,ha=({s:{v:a}})=>a===K?"list":a.name_||a.name||"?",L=a=>{throw Error("lui: "+a);},M=(a,b)=>{a===b||a&&b&&JSON.stringify(I(a))===JSON.stringify(I(b))||L("object keys mismatch")},N=(a,b,c)=>{g||L("hook called outside of hook context");c&&(c.constructor!==H&&L("deps must be in an array"),0===c.length&&L("deps must not be empty"));b&&0!==g[0].i&&L("hook called outside of component rendering");
a!==E&&h<g.length&&(g[h].i!==a&&L("inconsistent hook order"),g[h].h&&ia(g[h].h,c))},P=(a,b)=>{N(E,G,E);a!==O(a,a)&&L(b+" changed between renderings")},ia=(a,b)=>{b?a.length!==b.length&&L("deps length changed"):0<a.length&&L("deps presence changed")},ja=a=>new Function("a","b",`return a!==b&&(${a.join("||")})`),K=a=>{const b=(a=I(a)).join(",");return aa[b]||(0===a.length&&L("object empty"),a.some(c=>(c.includes("-")||"0123456789".includes(c.charAt(0)))&&L("invalid key: "+c)),aa[b]=ja(a.map(c=>`a.${c}!==b.`+
c)))},ka=(a,b)=>(M(a,b),a===b?D:I(a).filter(c=>a[c]!==b[c])),Q=a=>a?ba[a.length]||(0===a.length&&L("deps must not be empty"),ba[a.length]=ja(a.map((b,c)=>`a[${c}]!==b[${c}]`))):E,R=(a,b)=>{const c=e,d=b;g=c.u;h=1;c.B=G;if(c.s.v!==K){var k=E;try{k=c.s.v(c.s.o)}catch(z){if(z!==B)throw z;}var p=c.j;"object"!==typeof k&&L("components need to return child list or null");if(k){p&&(a=p,b=E);var m=k.length,l;"number"!==typeof m&&L("childs must be returned in a list");0===m&&L("returned childs list empty");
c.l&&m!==c.l.length&&L("returned childs count changed");var r=c.l||(c.l=(new H(m)).fill(E));do{var n=r[--m];if((l=k[m])&&l!==F){n&&n.s.v!==l.v&&L("child component changed at "+m);if(f=!n)(r[m]=e=n={s:l,O:l.o&&K(l.o),H:c,level:c.level+1,K:m,u:[],l:E,j:E,m:E,B:G}).u[0]={i:0,P:n},R(a,b),n.j&&a.insertBefore(n.m=n.j,b);else if(M(n.s.o,l.o),l.o&&n.O(n.s.o,l.o))(e=n).s=l,R(a,b);n.m&&(b=n.m)}else n&&(S(n,a),r[m]=E)}while(0<m)}else if(c.l){for(m of c.l)m&&S(m,a);c.l=E}p||(c.m=b!==d?b:E)}else{m=c.s.o.v;var A=
c.s.o.N;n=c.s.o.o;"object"===typeof A&&A&&A.constructor===H||L("list_data must be an array");"object"!==typeof n&&L("props must be an object");P(m,"item component");P(n&&I(n).join(","),"common props");r=A.length;if(!(0>=O(r,r)+r)){l=T();k={};p=[];A=0<r&&la(A,k,p);r||T();if(l.L){l.ba=n!==E&&l.O(n,l.ca);for(var x of l.aa)x in k||(S(l.L[x],a),delete l.L[x]);l.ca=n;l.aa=p}else l.L={},l.W=A?K(k[p[0]]):E,l.aa=p,l.O=(l.ca=n)&&K(n),l.ba=F;for(x=c.l=new H(r);0<r;){const z=p[--r];let y=l.L[z];if(f=!y)(l.L[z]=
e=y={s:{v:m,o:da({I:k[z]},n)},O:E,H:c,level:c.level+1,K:r,u:[],l:E,j:E,m:E,B:G}).u[0]={i:0,P:y},R(a,b),y.j&&a.insertBefore(y.m=y.j,b);else if(y.K!==r&&(ma(y,a,b),y.K=r),l.ba||A&&l.W(k[z],y.s.o.I))(e=y).s.o=da({I:k[z]},n),R(a,b);(x[r]=y).m&&(b=y.m)}c.m=b!==d?b:E}}},S=(a,b)=>{b&&a.j&&(b.removeChild(a.j),b=E);if(a.l)for(const c of a.l)c&&S(c,b);U(a.u);if(a.B){let c,d;(!(d=v[c=a.level])||0>(c=d.indexOf(a)))&&(!(d=w[c])||0>(c=d.indexOf(a)))||d.splice(c,1)}},U=a=>{let b,c=a.length;for(;1<c;)switch((b=a[--c]).i){case 3:b.G&&
b.G(...b.h);break;case 4:b.h=D;break;case 7:na(b);break;case 12:U(b.u)}},la=(a,b,c)=>{const d="object"===typeof a[0],k=T();k.ea||(a[0]!==E&&["object","string","number"].includes(k.ea=typeof a[0])||L("item type invalid"),d&&(!["string","number"].includes(k.ha=typeof a[0].id)&&L("item id type invalid"),k.keys=I(a[0]).join(",")));for(const p of a)p===E&&L("item is null"),typeof p!==k.ea&&L("item type changed"),d&&(typeof p.id!==k.ha&&L("item id type changed"),I(p).join(",")!==k.keys&&L("item keys differ of "+
p.id));for(const p of a)a=d?p.id:p,a in b&&L("item key not unique: "+a),b[a]=p,c.push(a);return d},ma=(a,b,c)=>{if(a.j)return b.insertBefore(a.j,c),a.j;if(a.m){let d=a.l.length;do a.l[--d]&&(c=ma(a.l[d],b,c));while(0<d)}return c},oa=a=>{for(;0!==a[0].i;){if(!a[0].V.D)return E;a[0].V.D=G;a=a[0].U}return a[0].P},W=a=>(a=oa(a))&&!a.B&&(a.B=F,v[a.level]?v[a.level].push(a):v[a.level]=[a],u||V()),pa=()=>{N(E,G,E);const a=oa(g);a&&(a.B=F,w[a.level]?w[a.level].push(a):w[a.level]=[a])},qa=(a,b)=>{N(3,G,b);
if(h>=g.length)g[h]={i:3,A:Q(b),h:b=b||D,G:a(...b)||E};else if(b){const c=g[h];c.A(c.h,b)&&(c.G&&c.G(...c.h),c.G=a(...(c.h=b))||E)}g[h].G&&g[h].G.then&&L("effect function must be synchronous");++h},ra=a=>{N(5,G,E);if(h<g.length)return g[h++].g;const b=g,c=[a,d=>{c[0]!==d&&(c[0]=d,W(b))},()=>c[0]];g[h++]={i:5,g:c};return c},T=a=>(N(6,G,E),(h<g.length?g[h++]:g[h++]={i:6,g:void 0===a?{}:a}).g),sa=(a,b)=>(N(8,G,b),h>=g.length?(g[h++]={i:8,A:Q(b),h:b=b||D,g:a(...b)}).g:b&&g[h].A(g[h].h,b)?g[h].g=a(...(g[h++].h=
b)):g[h++].g),O=(a,b)=>(N(9,G,E),h<g.length?(b=g[h].g,g[h++].g=a):g[h++]={i:9,g:a},b),ta=(a,b)=>(a=setTimeout(()=>b(F),a),()=>clearTimeout(a)),na=a=>{for(const b of a.X)U(a.M[b])},ua=(a,b,c)=>({Z:c.$,fa:a,Y:q,da:f?q:q+b}),X=a=>{"object"===typeof a&&a||L("object required");const b=O(a,E);return b?ka(b,a):I(a)},Y=a=>{P(!a,"attributes presence");const b=e.j;if(a){for(const c of X(a))switch(1<c.length&&c.charAt(0).toLowerCase()!==c.charAt(0)&&L("capital prop: "+c),c.charCodeAt(0)){case 70:"object"===
typeof a.F&&a.F||L("invalid css flags");b.className=I(a.F).filter(d=>a.F[d]).join(" ");continue;case 82:"function"!==typeof a.R&&L("invalid ref"),a.R(b);case 67:case 83:continue;default:97>c.charCodeAt(0)&&L("invalid prop: "+c),b[c]=a[c]}P(!a.S,"style presence");if(a.S)for(const c of X(a.S))b.style[c]=a.S[c]}return b},Z=(a,b,c)=>("string"===typeof a&&L("component expected, use node_dom instead"),c&&c.constructor!==H&&L("invalid childs type"),{v:a,o:b?c?(b.C=c,b):b:c?{C:c}:E}),V=()=>{f=0>=q;q=fa.now();
u=F;t=0;var a;let b=0;for(;(a=v).length;){10<++b&&L("rerender loop detected");v=[];for(const c of a)if(c)for(e of c)if(e.B){if(e.j)R(E,E);else{let d=E,k=e.m,p=e,m=e;for(;!(a=(p=p.H).j););do{let l=m.K;const {l:r}=m=m.H,n=r.length;for(;++l<n&&r[l]&&!(d=r[l].m););}while(!d&&m!==p);m=e;R(a,d);if(m.m!==k)for(;!(m=m.H).j;){k=E;for(const l of m.l)if(l&&(k=l.m))break;if(k===m.m)break;m.m=k}}f=G}}u=G;e=g=E;w.length&&(v=w,w=a,va())},va=()=>t||(t=requestAnimationFrame(V)),wa=a=>{var b=B[a];if(!b){const c=a.indexOf("[");
b=0>c?a.substr(0):a.substr(0,c);(0===b.length||b!==b.toLowerCase()||b.includes(" ")||b.includes("#")||b.includes("."))&&L("dom: invalid tag");B[a]=b=ea.createElement(b);if(0<c){!a.endsWith("]")&&L("dom: ] missing");for(const d of a.substring(c+1,a.length-1).split("]["))!d&&L("dom: empty attribute"),(d.includes("[")||d.includes("]"))&&L("dom: attributes screwed up"),a=d.indexOf("="),d.includes(" ")&&(0>a||d.indexOf(" ")<a)&&L("dom: space in attribute name"),0<a?b[d.substr(0,a)]=d.substr(a+1):b[d]=
F}}return b},xa=a=>{let b=C[a];if(!b){const c=wa(a);C[a]=b=d=>(f&&(e.j=c.cloneNode(F)),Y(d),d&&d.C||E);b.name_="$"+a}return b};J.onerror=()=>{if(e){var a=console,b=a.log;const c=[];let d=g,k=E;if(d){for(c.unshift("$"+(h-1));0!==d[0].i;)c.unshift(1===d[0].i?`hook_map[${"object"===typeof d[0].J?d[0].J.id:d[0].J}]`:"hook_sub"),d=d[0].U;d=d[0].P}for(;d;)c.unshift(ha(d)+(k?":"+k:"")),k=d.K,d=d.H;b.call(a,"lui "+(c.join("/")||"-")+": error",...[])}return v=w=[]};J.lui={defer:()=>(e&&L("defer while rendering"),u=F,va()),defer_end:()=>(e&&L("defer_end while rendering"),u||L("nothing was deferred"),cancelAnimationFrame(t),V()),hook_assert:a=>{N(E,G,E);if(!a)throw B;},hook_async:(a,b,c)=>{N(4,G,b);let d;if((h<g.length?(d=g[h++],G):d=g[h++]={i:4,A:Q(b),h:b||D,g:E})||b&&d.A(d.h,b)&&(d.h=b)){void 0!==c&&(d.g=c);const k=g;a(...d.h).then(p=>d.g!==p&&d.h===b&&(d.g=p,W(k)))}return d.g},hook_callback:(a,b)=>{const c=T();c.h&&ia(c.h,b);c.h=b;return c.ga||(c.ga=(...d)=>
a(...c.h,...d))},hook_delay:a=>{const [b,c]=ra(G);qa(ta,[a,c]);return b},hook_dom:(a,b)=>(N(E,F,E),e.j?f&&L("hook_dom called twice"):f||L("hook_dom skipped before"),b&&(b.C&&L("hook_dom cannot have childs"),b.R&&L("hook_dom cannot have a ref")),f&&(e.j=wa(a).cloneNode(F)),Y(b||E)),hook_effect:qa,hook_first:()=>(N(E,G,E),f),hook_map:(a,b,c)=>{N(7,G,c);let d=E,k=F;if(h<g.length)if((d=g[h]).T!==a)na(d),d=E;else if(!d.D||c&&d.A(d.h,c))d.h=c||D,d.D=F;else{if(b===d.N)return++h,d.g;k=G}const p=f,m=g,l=++h,
r={},n=[],A=0<b.length&&la(b,r,n);0===b.length&&T();if(d){if(d.g=[],d.N!==b){d.N=b;for(const x of d.X)x in r||(U(d.M[x]),delete d.M[x])}}else g[l-1]=d={i:7,A:Q(c),h:c||D,g:[],D:F,T:a,W:A?K(b[0]):E,X:[],M:{},N:b};for(const x of n){b=d.M[x];if(f=!b)d.M[x]=b=[{i:1,U:m,V:d,J:E,g:E}];if(k||f||(A?d.W(r[x],b[0].J):r[x]!==b[0].J)){g=b;h=1;try{b[0].g=a(b[0].J=r[x],...d.h)}catch(z){if(z!==B)throw z;}g=m}d.g.push(b[0].g)}f=p;g=m;h=l;d.X=n;return d.g},hook_memo:sa,hook_object_changes:X,hook_prev:O,hook_reducer:a=>
{N(10,G,E);a&&a.constructor!==H&&L("actions array required");"function"===typeof a&&L("array required, use hook_reducer_f instead");if(h<g.length)return g[h++].g;const b=g,c=[a[0](E),(d,k)=>{d=a[d](c[0],k);c[0]!==d&&(c[0]=d,W(b))}];g[h++]={i:10,g:c};return c},hook_reducer_f:(a,b)=>{N(11,G,E);"function"!==typeof a&&L("reducer function required");b&&"function"!==typeof b&&L("initializer must be a function");if(h<g.length)return g[h++].g;const c=g,d=[b?b():E,k=>{k=a(d[0],k);d[0]!==k&&(d[0]=k,W(c))}];
g[h++]={i:11,g:d};return d},hook_rerender:pa,hook_state:ra,hook_static:T,hook_sub:(a,b)=>{N(12,G,b);let c=E;if(h<g.length)if((c=g[h]).T!==a)U(c.u),c=E;else if(!c.D||b&&c.A(c.h,b))b&&(c.h=b),c.D=F;else return++h,c.g;const d=f,k=g,p=h;if(f=!c)(g[h]=c={i:12,A:Q(b),h:b||D,g:E,T:a,D:F,u:[]}).u[0]={i:2,U:g,V:c};g=c.u;h=1;try{c.g=a(...c.h)}catch(m){if(m!==B)throw m;}f=d;g=k;h=p+1;return c.g},hook_transition:(a,b)=>{const c=T({$:a});a=sa(ua,[a,b,c]);return c.$=a.da<=q?a.fa:(pa(),a.Y===q?a.Z:a.Z+(a.fa-a.Z)*
(q-a.Y)/(a.da-a.Y))},init:a=>{(e||v.length||w.length)&&L("init called more than once");"function"!==typeof a&&L("init function requires body component");let b;const c=ea.body;c.innerHTML="";const d=()=>((!(b=a())||2!==b.length)&&L("root component must return [props, childs]"),P(!b[0],"attributes presence"),b[0]!==E&&("object"!==typeof b[0]&&L("invalid props type"),M(O(b[0],b[0]),b[0]),b[0].C&&L("body childs must be in second return value")),Y(b[0]),b[1]);d.name_="$body";(e={s:{v:d,o:E},O:E,H:E,level:0,
K:0,u:[],l:E,j:c,m:c,B:F}).u[0]={i:0,P:e};v[0]=[e];e=g=E;V()},node:Z,node_dom:(a,b,c)=>Z(xa(a),b,c),node_map:(a,b,c)=>Z(K,{v:a,N:b,o:c||E}),now:()=>q}}